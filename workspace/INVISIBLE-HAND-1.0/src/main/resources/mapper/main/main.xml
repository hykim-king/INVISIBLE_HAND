<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.main">
  
  <update id="doUpdateViews" parameterType="BoardVO">
      UPDATE board           
      SET views   = NVL(views,0)+1   
      WHERE postnumber = #{postnumber}
      AND categorynumber = #{categorynumber}
   
  </update>

  <select id="doSelectOne" parameterType="BoardVO" resultType="BoardVO">
    SELECT
      postnumber
			, author
			, title
			, content
			, TO_CHAR(reg_dt,'YYYY-MM-DD HH24:MI:SS') writtendate
			, likes
			, views
			, categorynumber
		FROM board
		WHERE postnumber = #{postnumber}
		  AND categorynumber = #{categorynumber}
  </select>
       
  <select id="doRetrieve" parameterType="DTO" resultType="BoardVO">
		<![CDATA[
			SELECT A.*,B.*
			FROM (
			  SELECT TT1.rnum as num,
			         TT1.title,
			         TT1.categorynumber,
			         TT1.views,
			         CASE
			           WHEN TRUNC(TT1.writtendate) = TRUNC(SYSDATE) THEN TO_CHAR(TT1.writtendate, 'HH24:MI')
			           ELSE TO_CHAR(TT1.writtendate, 'YYYY/MM/DD')
			         END AS writtendate,
			         TT1.author,
			         TT1.postnumber
			  FROM (
			    SELECT ROWNUM as rnum, t1.*
			    FROM (
			      SELECT *
			      FROM board
			      WHERE categorynumber = #{categorynumber}
			      ORDER BY views DESC, writtendate DESC
			    ) t1
			  ) TT1
			  WHERE TT1.rnum <=  5
			) A
			CROSS JOIN (
			  SELECT COUNT(postnumber) totalCnt
			  FROM board
			  WHERE categorynumber = #{categorynumber}
			) B
			WHERE A.rnum >=  1
			]]>

</select>


</mapper>