<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.main">
  
  <update id="doUpdateViews" parameterType="PostVO">
      UPDATE board           
      SET views   = NVL(views,0)+1   
      WHERE postnumber = #{postnumber}
      AND categorynumber = #{categorynumber}
   
  </update>

  <select id="doSelectOne" parameterType="PostVO" resultType="PostVO">
    SELECT
      postnumber
			, nickname
			, title
			, content
			, TO_CHAR(writtendate,'YYYY-MM-DD HH24:MI:SS') writtendate
			, likes
			, views
			, categorynumber
		FROM board
		WHERE postnumber = #{postnumber}
		  AND categorynumber = #{categorynumber}
  </select>
       
  <select id="doRetrieve" parameterType="DTO" resultType="PostVO">
		<![CDATA[
		SELECT A.*, B.*
		FROM (
		  SELECT TT1.rnum as num,
		         TT1.title,
		         TT1.categorynumber,
		         TT1.views,
		         CASE
		           WHEN TRUNC(TT1.writtendate) = TRUNC(SYSDATE) THEN TO_CHAR(TT1.writtendate, 'HH24:MI')
		           ELSE TO_CHAR(TT1.writtendate, 'YYYY/MM/DD')
		         END AS writtendate,
		         TT1.nickname,
		         TT1.postnumber
		  FROM (
		    SELECT ROWNUM as rnum, t1.*
		    FROM (
		      SELECT *
		      FROM board
		      WHERE categorynumber = #{categorynumber}
		      ORDER BY views DESC, writtendate DESC
		    ) t1
		  ) TT1  
		  WHERE TT1.rnum >= 1
		) A
		CROSS JOIN (
		  SELECT COUNT(postnumber) totalCnt
		  FROM board
		  WHERE categorynumber = #{categorynumber}
		) B
		INNER JOIN COMMON_CODE_TABLE M ON A.categorynumber = M.CODEDETAIL
		WHERE M.MASTERCODE = 'CategoryNumber'
		AND A.num <=5;
			]]>

  </select>


</mapper>