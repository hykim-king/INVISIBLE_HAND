<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pcwk.ehr.board">

  <!-- 검색조건 -->
  <sql id="searchCondition">
     <choose>
      <when test=" '' != searchWord  and '10' == searchDiv  ">
         AND title  LIKE #{searchWord} || '%'
      </when>
      <when test=" '' != searchWord  and '20' == searchDiv  ">
         AND contents  LIKE #{searchWord} || '%'
      </when>
     </choose>
  </sql>
  <!-- title:10, contents:20  -->
  <select id="doRetrieve" parameterType="com.pcwk.ehr.cmn.DTO" resultType="BoardVO">
		
		SELECT A.*,B.*
		FROM (
		    SELECT TT1.rnum as num,
		           TT1.title,
		           TT1.div,
		           TT1.read_cnt,
		           --당일 등록이면 : 16:26 그렇치 않으면 2023/06/28
		           DECODE( TO_CHAR(TT1.mod_dt,'YYYYMMDD'),TO_CHAR(sysdate,'YYYYMMDD')
		                  ,TO_CHAR(TT1.mod_dt,'HH24:MI')
		                  ,TO_CHAR(TT1.mod_dt,'YYYY/MM/DD') )mod_dt,
		           TT1.mod_id,
		           TT1.seq
		    FROM (
		        SELECT ROWNUM as rnum, t1.*
		        FROM (
		            SELECT *
		            FROM board
		            WHERE div = #{div}
		            <include refid="searchCondition"></include>
		            ORDER BY mod_dt DESC
		        )t1
		      <![CDATA[     WHERE ROWNUM <= #{pageSize} * (#{pageNo}-1)+#{pageSize}   ]]>
		    )TT1
		    --WHERE rnum >=1
		   <![CDATA[    WHERE rnum >=#{pageSize} * (#{pageNo}-1)+ 1 ]]>
		)A
		CROSS JOIN
		(
		SELECT COUNT(SEQ) totalCnt
		FROM board
		WHERE div = #{div}
		<include refid="searchCondition"></include>
		)B  
	
  </select>

  <update id="doUpdateReadCnt" parameterType="BoardVO">
      <![CDATA[ 
			UPDATE board
			   SET read_cnt = NVL(read_cnt,0)+1
			 WHERE seq = #{seq}
			   AND reg_id  <> #{modId}
			]]>      
  </update>
  
  
  <update id="doUpdate" parameterType="BoardVO">
			UPDATE board           
			SET title    = #{title},      
			    contents = #{contents},      
			    div      = #{div},
			    mod_dt   = SYSDATE,
			    mod_id   = #{modId}       
			WHERE seq = #{seq}  
  </update>
  
  
	<delete id="doDelete" parameterType="BoardVO">
			DELETE FROM board 
			WHERE seq = #{seq}     
	</delete>

  <insert id="doSave" parameterType="BoardVO">
      <selectKey keyProperty="seq" resultType="int" order="BEFORE">
         SELECT BOARD_SEQ.NEXTVAL FROM DUAL
      </selectKey>
			INSERT INTO board (
			    seq,           
			    title,         
			    contents,   
			    div,   
			    read_cnt,      
			    reg_id,        
			    mod_id     
			) VALUES (         
			    #{seq },             
			    #{title},             
			    #{contents},             
			    #{div},             
			    0,  
	        #{regId}, 		               
			    #{regId}              
			)  
  </insert>

  <select id="doSelectOne" parameterType="BoardVO" 
     resultType="BoardVO">
		 SELECT                                              
		     seq,                                            
		     title,                                          
		     contents,    
		     div,                                   
		     read_cnt,                                       
		     TO_CHAR(reg_dt,'YYYY-MM-DD HH24:MI:SS')  reg_dt,
		     reg_id,                                         
		     TO_CHAR(mod_dt,'YYYY-MM-DD HH24:MI:SS')  mod_dt,
		     mod_id                                          
		 FROM board                                          
		 WHERE seq = #{seq}    
  </select>


</mapper>